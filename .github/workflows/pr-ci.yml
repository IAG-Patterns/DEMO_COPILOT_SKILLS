name: PR CI - Build & Security Scan

on:
  pull_request:
    branches: [master, main]
    types: [opened, synchronize, reopened]

permissions:
  contents: read
  pull-requests: write

concurrency:
  group: pr-ci-${{ github.workflow }}-${{ github.event.pull_request.number }}
  cancel-in-progress: true

jobs:
  build-and-scan:
    runs-on: ubuntu-latest
    env:
      DOCKER_IMAGE_TAG: demo-copilot-skills:pr-${{ github.event.pull_request.number }}
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci --legacy-peer-deps

      - name: Run linting
        run: npm run lint || true
        continue-on-error: true

      - name: Build application
        run: npm run build

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build Docker image
        id: docker_build
        uses: docker/build-push-action@v6
        with:
          context: .
          file: ./Dockerfile
          push: false
          load: true
          tags: ${{ env.DOCKER_IMAGE_TAG }}
        continue-on-error: true

      #########################################
      # Security Scanning with Snyk
      #########################################
      
      # Check Snyk token FIRST (with if: always() to run even if Docker fails)
      - name: Check Snyk Token
        id: check_snyk
        if: always()
        env:
          SNYK_TOKEN: ${{ secrets.SNYK_TOKEN }}
        run: |
          if [ -n "$SNYK_TOKEN" ]; then
            echo "has_token=true" >> $GITHUB_OUTPUT
            echo "âœ… SNYK_TOKEN is configured"
          else
            echo "has_token=false" >> $GITHUB_OUTPUT
            echo "âš ï¸ SNYK_TOKEN not configured - skipping Snyk scans"
          fi

      # Scan Docker image for vulnerabilities
      # Note: --policy-path honors .snyk file for license ignores
      - name: Snyk Container Scan
        id: snyk_container
        if: steps.check_snyk.outputs.has_token == 'true' && steps.docker_build.outcome == 'success'
        uses: snyk/actions/docker@master
        with:
          image: ${{ env.DOCKER_IMAGE_TAG }}
          args: >-
            --severity-threshold=medium
            --file=Dockerfile
            --policy-path=.snyk
            --json-file-output=snyk-container.json
        env:
          SNYK_TOKEN: ${{ secrets.SNYK_TOKEN }}
        continue-on-error: true

      # Save container scan output to JSON
      - name: Save Container Scan JSON
        if: always() && steps.check_snyk.outputs.has_token == 'true' && steps.docker_build.outcome == 'success'
        run: |
          snyk container test "${{ env.DOCKER_IMAGE_TAG }}" \
            --severity-threshold=medium \
            --file=Dockerfile \
            --policy-path=.snyk \
            --json > snyk-container.json 2>&1 || true
        env:
          SNYK_TOKEN: ${{ secrets.SNYK_TOKEN }}
        continue-on-error: true

      # Scan dependencies for vulnerabilities  
      # Note: .snyk policy file is auto-detected in working directory
      - name: Snyk Open Source Scan
        id: snyk_deps
        if: always() && steps.check_snyk.outputs.has_token == 'true'
        uses: snyk/actions/node@master
        with:
          command: test
          args: >-
            --severity-threshold=low
            --policy-path=.snyk
            --json-file-output=snyk-deps.json
        env:
          SNYK_TOKEN: ${{ secrets.SNYK_TOKEN }}
        continue-on-error: true

      # Save dependency scan output to JSON
      - name: Save Dependency Scan JSON
        if: always() && steps.check_snyk.outputs.has_token == 'true'
        run: |
          snyk test --severity-threshold=low --policy-path=.snyk --json > snyk-deps.json 2>&1 || true
        env:
          SNYK_TOKEN: ${{ secrets.SNYK_TOKEN }}
        continue-on-error: true

      #########################################
      # Check Snyk Results & Generate Report
      #########################################
      - name: Analyze Snyk Results
        id: snyk_analysis
        if: always()
        run: |
          echo "## ğŸ”’ Security Scan Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          HAS_TOKEN="${{ steps.check_snyk.outputs.has_token }}"
          DOCKER_BUILD="${{ steps.docker_build.outcome }}"
          
          if [ "$HAS_TOKEN" != "true" ]; then
            echo "### âš ï¸ Snyk Token Not Configured" >> $GITHUB_STEP_SUMMARY
            echo "Security scans were skipped because \`SNYK_TOKEN\` secret is not set." >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "To enable security scanning:" >> $GITHUB_STEP_SUMMARY
            echo "1. Get your token from https://app.snyk.io/account" >> $GITHUB_STEP_SUMMARY
            echo "2. Add \`SNYK_TOKEN\` to repository secrets" >> $GITHUB_STEP_SUMMARY
            echo "has_container_vulns=false" >> $GITHUB_OUTPUT
            echo "has_dep_vulns=false" >> $GITHUB_OUTPUT
            echo "has_vulnerabilities=false" >> $GITHUB_OUTPUT
            echo "snyk_skipped=true" >> $GITHUB_OUTPUT
            exit 0
          fi
          
          echo "snyk_skipped=false" >> $GITHUB_OUTPUT
          
          # Docker build status
          if [ "$DOCKER_BUILD" != "success" ]; then
            echo "### âš ï¸ Docker Build Failed" >> $GITHUB_STEP_SUMMARY
            echo "Container scan was skipped because Docker image build failed." >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
          fi
          
          # Container scan results
          if [ "$DOCKER_BUILD" == "success" ] && [ "${{ steps.snyk_container.outcome }}" == "failure" ]; then
            echo "### ğŸš¨ Container Vulnerabilities Found" >> $GITHUB_STEP_SUMMARY
            echo "The Docker image contains security vulnerabilities." >> $GITHUB_STEP_SUMMARY
            echo "has_container_vulns=true" >> $GITHUB_OUTPUT
          else
            if [ "$DOCKER_BUILD" == "success" ]; then
              echo "### âœ… Container Scan Passed" >> $GITHUB_STEP_SUMMARY
            fi
            echo "has_container_vulns=false" >> $GITHUB_OUTPUT
          fi
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # Dependencies scan results
          if [ "${{ steps.snyk_deps.outcome }}" == "failure" ]; then
            echo "### âš ï¸ Dependency Vulnerabilities Found" >> $GITHUB_STEP_SUMMARY
            echo "Some dependencies have known vulnerabilities." >> $GITHUB_STEP_SUMMARY
            echo "has_dep_vulns=true" >> $GITHUB_OUTPUT
          else
            echo "### âœ… Dependency Scan Passed" >> $GITHUB_STEP_SUMMARY
            echo "has_dep_vulns=false" >> $GITHUB_OUTPUT
          fi
          
          # Overall status
          if [ "${{ steps.snyk_container.outcome }}" == "failure" ] || \
             [ "${{ steps.snyk_deps.outcome }}" == "failure" ]; then
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "---" >> $GITHUB_STEP_SUMMARY
            echo "**Action Required:** Please review and fix the security vulnerabilities before merging." >> $GITHUB_STEP_SUMMARY
            echo "has_vulnerabilities=true" >> $GITHUB_OUTPUT
          else
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "---" >> $GITHUB_STEP_SUMMARY
            echo "**All security checks passed!** âœ…" >> $GITHUB_STEP_SUMMARY
            echo "has_vulnerabilities=false" >> $GITHUB_OUTPUT
          fi

      # Save scan logs for AI autofix
      - name: Save Snyk Logs
        if: always()
        run: |
          mkdir -p scan-results
          
          if [ "${{ steps.check_snyk.outputs.has_token }}" != "true" ]; then
            echo "Snyk scans skipped - SNYK_TOKEN not configured" > scan-results/snyk_scan.log
            exit 0
          fi
          
          # Create comprehensive log file
          echo "# Snyk Security Scan Results" > scan-results/snyk_scan.log
          echo "# PR: #${{ github.event.pull_request.number }}" >> scan-results/snyk_scan.log
          echo "# Commit: ${{ github.sha }}" >> scan-results/snyk_scan.log
          echo "# Scanned: $(date -u +%Y-%m-%dT%H:%M:%SZ)" >> scan-results/snyk_scan.log
          echo "" >> scan-results/snyk_scan.log
          
          # Container scan results
          echo "## Container Scan (Dockerfile)" >> scan-results/snyk_scan.log
          echo "Status: ${{ steps.snyk_container.outcome }}" >> scan-results/snyk_scan.log
          echo "" >> scan-results/snyk_scan.log
          
          if [ -f snyk-container.json ]; then
            echo "### Vulnerabilities Found:" >> scan-results/snyk_scan.log
            # Extract vulnerability summary from JSON
            jq -r '
              if type == "object" and has("vulnerabilities") then
                .vulnerabilities | group_by(.severity) | map({
                  severity: .[0].severity,
                  count: length,
                  items: [.[] | {name: .name, version: .version, title: .title, fixedIn: .fixedIn[0]}][:5]
                }) | .[] | 
                "#### \(.severity | ascii_upcase) (\(.count) found):\n" +
                (.items | map("- \(.name)@\(.version): \(.title)" + if .fixedIn then " (fix: \(.fixedIn))" else "" end) | join("\n"))
              else
                "No vulnerabilities data available"
              end
            ' snyk-container.json >> scan-results/snyk_scan.log 2>/dev/null || echo "Could not parse container scan results" >> scan-results/snyk_scan.log
            echo "" >> scan-results/snyk_scan.log
            echo "### Full Container Scan JSON:" >> scan-results/snyk_scan.log
            cat snyk-container.json >> scan-results/snyk_scan.log
          else
            echo "No container scan results available" >> scan-results/snyk_scan.log
          fi
          echo "" >> scan-results/snyk_scan.log
          
          # Save dependency scan output
          echo "=== Snyk Dependency Scan ===" >> scan-results/snyk_scan.log
          echo "Outcome: ${{ steps.snyk_deps.outcome }}" >> scan-results/snyk_scan.log
          if [ -f snyk-deps.json ]; then
            echo "### Vulnerabilities Found:" >> scan-results/snyk_scan.log
            jq -r '
              if type == "object" and has("vulnerabilities") then
                .vulnerabilities | group_by(.severity) | map({
                  severity: .[0].severity,
                  count: length,
                  items: [.[] | {name: .name, version: .version, title: .title, fixedIn: .fixedIn[0]}][:5]
                }) | .[] | 
                "#### \(.severity | ascii_upcase) (\(.count) found):\n" +
                (.items | map("- \(.name)@\(.version): \(.title)" + if .fixedIn then " (fix: \(.fixedIn))" else "" end) | join("\n"))
              else
                "No vulnerabilities data available"
              end
            ' snyk-deps.json >> scan-results/snyk_scan.log 2>/dev/null || echo "Could not parse dependency scan results" >> scan-results/snyk_scan.log
            echo "" >> scan-results/snyk_scan.log
            echo "### Full Dependency Scan JSON:" >> scan-results/snyk_scan.log
            cat snyk-deps.json >> scan-results/snyk_scan.log
          else
            echo "No dependency scan results available" >> scan-results/snyk_scan.log
          fi
          
          # Show summary
          echo ""
          echo "ğŸ“Š Scan log created: $(wc -c < scan-results/snyk_scan.log) bytes"
          head -30 scan-results/snyk_scan.log

      - name: Upload Scan Results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: security-scan-results-pr-${{ github.event.pull_request.number }}
          path: scan-results/
          retention-days: 30

      #########################################
      # Comment on PR with Results
      #########################################
      - name: Comment on PR
        if: always()
        uses: actions/github-script@v7
        with:
          script: |
            const snykSkipped = '${{ steps.snyk_analysis.outputs.snyk_skipped }}' === 'true';
            const hasVulns = '${{ steps.snyk_analysis.outputs.has_vulnerabilities }}' === 'true';
            const hasContainerVulns = '${{ steps.snyk_analysis.outputs.has_container_vulns }}' === 'true';
            const hasDepVulns = '${{ steps.snyk_analysis.outputs.has_dep_vulns }}' === 'true';
            const dockerBuildFailed = '${{ steps.docker_build.outcome }}' !== 'success';
            
            let body = '## ğŸ”’ Security Scan Report\n\n';
            
            if (snykSkipped) {
              body += 'âš ï¸ **Security scans were skipped**\n\n';
              body += 'The `SNYK_TOKEN` secret is not configured.\n\n';
              body += 'To enable security scanning:\n';
              body += '1. Get your token from https://app.snyk.io/account\n';
              body += '2. Add `SNYK_TOKEN` to [repository secrets](../../settings/secrets/actions)\n';
            } else if (hasVulns) {
              body += 'âš ï¸ **Security vulnerabilities were detected in this PR.**\n\n';
              body += '| Scan Type | Status |\n';
              body += '|-----------|--------|\n';
              if (dockerBuildFailed) {
                body += '| Container (Dockerfile) | â­ï¸ Skipped (build failed) |\n';
              } else {
                body += `| Container (Dockerfile) | ${hasContainerVulns ? 'ğŸš¨ Issues Found' : 'âœ… Passed'} |\n`;
              }
              body += `| Dependencies | ${hasDepVulns ? 'âš ï¸ Issues Found' : 'âœ… Passed'} |\n`;
              body += '\n---\n';
              body += 'ğŸ’¡ **Tip:** Run the [AI Autofix workflow](../../actions/workflows/ai-autofix.yml) to automatically fix these issues.\n';
            } else {
              body += 'âœ… **All security checks passed!**\n\n';
              body += 'No vulnerabilities were detected in the container or dependencies.';
            }
            
            // Find existing comment
            const { data: comments } = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number
            });
            
            const botComment = comments.find(c => 
              c.user.type === 'Bot' && 
              c.body.includes('ğŸ”’ Security Scan Report')
            );
            
            if (botComment) {
              await github.rest.issues.updateComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: botComment.id,
                body: body
              });
            } else {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                body: body
              });
            }

      #########################################
      # Fail CI if vulnerabilities found
      #########################################
      - name: Fail if vulnerabilities found
        if: always()
        run: |
          if [ "${{ steps.snyk_analysis.outputs.has_vulnerabilities }}" == "true" ]; then
            echo "âŒ Security vulnerabilities were detected!"
            echo ""
            echo "Container vulnerabilities: ${{ steps.snyk_analysis.outputs.has_container_vulns }}"
            echo "Dependency vulnerabilities: ${{ steps.snyk_analysis.outputs.has_dep_vulns }}"
            echo ""
            echo "Please fix the vulnerabilities or run the AI Autofix workflow."
            exit 1
          fi
          echo "âœ… No security vulnerabilities detected"
