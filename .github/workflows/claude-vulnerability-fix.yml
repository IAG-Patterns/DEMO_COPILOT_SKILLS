name: Claude Code Vulnerability Fix

on:
  workflow_dispatch:
    inputs:
      target_repo:
        description: 'Repository to scan (owner/repo format, leave empty for current repo)'
        required: false
        type: string
      target_branch:
        description: 'Branch to scan (default: main)'
        required: false
        default: 'main'
        type: string
      scan_tool:
        description: 'Security scan tool to use'
        required: true
        default: 'npm-audit'
        type: choice
        options:
          - npm-audit
          - snyk
          - trivy
          - all
      fix_severity:
        description: 'Minimum severity to fix'
        required: true
        default: 'high'
        type: choice
        options:
          - critical
          - high
          - medium
          - low

  # Can also be triggered after a security scan workflow
  workflow_run:
    workflows: ["Security Scan", "Snyk Scan", "CodeQL Analysis"]
    types:
      - completed

permissions:
  contents: write
  pull-requests: write
  security-events: read
  actions: read
  id-token: write

jobs:
  security-fix:
    runs-on: ubuntu-latest
    env:
      ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
      GH_TOKEN: ${{ secrets.PERSONAL_ACCESS_TOKEN || github.token }}
      SNYK_TOKEN: ${{ secrets.SNYK_TOKEN }}
    
    steps:
      - name: Determine Target Repository
        id: target
        run: |
          if [ -n "${{ github.event.inputs.target_repo }}" ]; then
            TARGET_REPO="${{ github.event.inputs.target_repo }}"
          else
            TARGET_REPO="${{ github.repository }}"
          fi
          
          TARGET_BRANCH="${{ github.event.inputs.target_branch || 'main' }}"
          SCAN_TOOL="${{ github.event.inputs.scan_tool || 'npm-audit' }}"
          FIX_SEVERITY="${{ github.event.inputs.fix_severity || 'high' }}"
          
          OWNER="${TARGET_REPO%/*}"
          REPO="${TARGET_REPO#*/}"
          
          echo "target_repo=$TARGET_REPO" >> $GITHUB_OUTPUT
          echo "owner=$OWNER" >> $GITHUB_OUTPUT
          echo "repo=$REPO" >> $GITHUB_OUTPUT
          echo "branch=$TARGET_BRANCH" >> $GITHUB_OUTPUT
          echo "scan_tool=$SCAN_TOOL" >> $GITHUB_OUTPUT
          echo "fix_severity=$FIX_SEVERITY" >> $GITHUB_OUTPUT
          
          echo "Target: $TARGET_REPO @ $TARGET_BRANCH"
          echo "Scan tool: $SCAN_TOOL"
          echo "Fix severity: $FIX_SEVERITY+"

      - name: Checkout Target Repository
        uses: actions/checkout@v4
        with:
          repository: ${{ steps.target.outputs.target_repo }}
          ref: ${{ steps.target.outputs.branch }}
          fetch-depth: 0
          token: ${{ secrets.PERSONAL_ACCESS_TOKEN || github.token }}

      - name: Checkout Infra Files
        uses: actions/checkout@v4
        with:
          repository: ${{ github.repository }}
          ref: ${{ github.ref }}
          path: _infra
          sparse-checkout: |
            .github/CLAUDE.md
            .github/claude-config
          token: ${{ secrets.PERSONAL_ACCESS_TOKEN || github.token }}

      - name: Copy Config Files
        run: |
          mkdir -p .claude-config
          cp _infra/.github/CLAUDE.md . 2>/dev/null || echo "No CLAUDE.md found"
          cp -r _infra/.github/claude-config/* .claude-config/ 2>/dev/null || echo "No claude-config found"
          rm -rf _infra

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install Security Tools
        run: |
          # Install npm-audit-resolver for npm-audit
          npm install -g npm-audit-resolver 2>/dev/null || true
          
          # Install Snyk CLI if token is available
          if [ -n "$SNYK_TOKEN" ]; then
            npm install -g snyk
            snyk auth "$SNYK_TOKEN" 2>/dev/null || true
          fi
          
          # Install Trivy
          curl -sfL https://raw.githubusercontent.com/aquasecurity/trivy/main/contrib/install.sh | sh -s -- -b /usr/local/bin v0.48.0 2>/dev/null || true
          
          # Install pip-audit for Python
          pip install pip-audit 2>/dev/null || true

      - name: Run NPM Audit
        id: npm_audit
        if: steps.target.outputs.scan_tool == 'npm-audit' || steps.target.outputs.scan_tool == 'all'
        continue-on-error: true
        run: |
          if [ -f package.json ]; then
            echo "Running npm audit..."
            npm audit --json > npm_audit_raw.json 2>&1 || true
            
            # Convert npm audit to our vulnerability format
            jq '{
              scan_tool: "npm-audit",
              scan_date: (now | strftime("%Y-%m-%dT%H:%M:%SZ")),
              vulnerabilities: [
                .vulnerabilities | to_entries[] | .value | {
                  id: .via[0].source // "unknown",
                  severity: .severity,
                  package: .name,
                  current_version: .range,
                  fixed_version: (.fixAvailable.version // "unknown"),
                  file: "package.json",
                  description: (.via[0].title // "No description"),
                  recommendation: ("Upgrade to " + (.fixAvailable.version // "latest"))
                }
              ]
            }' npm_audit_raw.json > npm_vulnerabilities.json 2>/dev/null || echo '{"vulnerabilities":[]}' > npm_vulnerabilities.json
            
            echo "has_npm=true" >> $GITHUB_OUTPUT
          else
            echo "has_npm=false" >> $GITHUB_OUTPUT
          fi

      - name: Run Snyk Scan
        id: snyk_scan
        if: (steps.target.outputs.scan_tool == 'snyk' || steps.target.outputs.scan_tool == 'all') && env.SNYK_TOKEN != ''
        continue-on-error: true
        run: |
          echo "Running Snyk scan..."
          snyk test --json > snyk_raw.json 2>&1 || true
          
          # Convert Snyk output to our format
          jq '{
            scan_tool: "snyk",
            scan_date: (now | strftime("%Y-%m-%dT%H:%M:%SZ")),
            vulnerabilities: [
              .vulnerabilities[]? | {
                id: .id,
                severity: .severity,
                package: .packageName,
                current_version: .version,
                fixed_version: (.fixedIn[0] // "unknown"),
                file: (.from[0] // "package.json"),
                description: .title,
                recommendation: (.remediation // "Upgrade to fixed version")
              }
            ]
          }' snyk_raw.json > snyk_vulnerabilities.json 2>/dev/null || echo '{"vulnerabilities":[]}' > snyk_vulnerabilities.json
          
          echo "has_snyk=true" >> $GITHUB_OUTPUT

      - name: Run Trivy Scan
        id: trivy_scan
        if: steps.target.outputs.scan_tool == 'trivy' || steps.target.outputs.scan_tool == 'all'
        continue-on-error: true
        run: |
          echo "Running Trivy scan..."
          trivy fs --format json --output trivy_raw.json . 2>/dev/null || true
          
          # Convert Trivy output to our format
          if [ -f trivy_raw.json ]; then
            jq '{
              scan_tool: "trivy",
              scan_date: (now | strftime("%Y-%m-%dT%H:%M:%SZ")),
              vulnerabilities: [
                .Results[]?.Vulnerabilities[]? | {
                  id: .VulnerabilityID,
                  severity: (.Severity | ascii_downcase),
                  package: .PkgName,
                  current_version: .InstalledVersion,
                  fixed_version: (.FixedVersion // "unknown"),
                  file: "filesystem",
                  description: .Title,
                  recommendation: ("Upgrade to " + (.FixedVersion // "latest"))
                }
              ]
            }' trivy_raw.json > trivy_vulnerabilities.json 2>/dev/null || echo '{"vulnerabilities":[]}' > trivy_vulnerabilities.json
            
            echo "has_trivy=true" >> $GITHUB_OUTPUT
          else
            echo "has_trivy=false" >> $GITHUB_OUTPUT
          fi

      - name: Run Pip Audit (Python)
        id: pip_audit
        if: steps.target.outputs.scan_tool == 'all'
        continue-on-error: true
        run: |
          if [ -f requirements.txt ] || [ -f setup.py ] || [ -f pyproject.toml ]; then
            echo "Running pip-audit..."
            pip-audit --format json --output pip_audit_raw.json 2>/dev/null || true
            
            if [ -f pip_audit_raw.json ]; then
              jq '{
                scan_tool: "pip-audit",
                scan_date: (now | strftime("%Y-%m-%dT%H:%M:%SZ")),
                vulnerabilities: [
                  .[]? | {
                    id: .id,
                    severity: "high",
                    package: .name,
                    current_version: .version,
                    fixed_version: (.fix_versions[0] // "unknown"),
                    file: "requirements.txt",
                    description: .description,
                    recommendation: ("Upgrade to " + (.fix_versions[0] // "latest"))
                  }
                ]
              }' pip_audit_raw.json > pip_vulnerabilities.json 2>/dev/null || echo '{"vulnerabilities":[]}' > pip_vulnerabilities.json
              
              echo "has_pip=true" >> $GITHUB_OUTPUT
            fi
          else
            echo "has_pip=false" >> $GITHUB_OUTPUT
          fi

      - name: Merge Vulnerability Reports
        id: merge_reports
        run: |
          FIX_SEVERITY="${{ steps.target.outputs.fix_severity }}"
          
          # Define severity order for filtering
          case "$FIX_SEVERITY" in
            critical) SEVERITY_FILTER='["critical"]' ;;
            high) SEVERITY_FILTER='["critical", "high"]' ;;
            medium) SEVERITY_FILTER='["critical", "high", "medium"]' ;;
            low) SEVERITY_FILTER='["critical", "high", "medium", "low"]' ;;
          esac
          
          echo "Merging vulnerability reports (severity >= $FIX_SEVERITY)..."
          
          # Merge all vulnerability files
          jq -s --argjson severities "$SEVERITY_FILTER" '
            {
              scan_date: (now | strftime("%Y-%m-%dT%H:%M:%SZ")),
              minimum_severity: $severities[0],
              vulnerabilities: [
                .[].vulnerabilities[]? 
                | select(.severity as $s | $severities | index($s))
              ] | unique_by(.id)
            }
          ' *_vulnerabilities.json > vulnerability_report.json 2>/dev/null || echo '{"vulnerabilities":[]}' > vulnerability_report.json
          
          VULN_COUNT=$(jq '.vulnerabilities | length' vulnerability_report.json)
          echo "Found $VULN_COUNT vulnerabilities to fix"
          echo "vuln_count=$VULN_COUNT" >> $GITHUB_OUTPUT
          
          # Display summary
          echo ""
          echo "Vulnerability Summary:"
          jq -r '.vulnerabilities | group_by(.severity) | .[] | "\(.[0].severity): \(length)"' vulnerability_report.json

      - name: Upload Scan Results
        uses: actions/upload-artifact@v4
        with:
          name: vulnerability-scan-results
          path: |
            vulnerability_report.json
            *_vulnerabilities.json
            *_raw.json
          retention-days: 30

      - name: Check for Vulnerabilities
        if: steps.merge_reports.outputs.vuln_count == '0'
        run: |
          echo "No vulnerabilities found at severity level ${{ steps.target.outputs.fix_severity }} or higher."
          echo "Nothing to fix!"
          exit 0

      - name: Prepare Fix Branch
        if: steps.merge_reports.outputs.vuln_count != '0'
        run: |
          TIMESTAMP=$(date +%Y%m%d-%H%M%S)
          BRANCH_NAME="claude-security-fix/$TIMESTAMP"
          
          git config user.name "claude-code-agent"
          git config user.email "claude-agent@anthropic.com"
          
          git switch -c "$BRANCH_NAME"
          
          echo "branch_name=$BRANCH_NAME" >> $GITHUB_ENV

      - name: Run Claude Code Agent for Security Fixes
        if: steps.merge_reports.outputs.vuln_count != '0'
        id: claude_agent
        uses: anthropics/claude-code-action@v1
        with:
          claude_code_oauth_token: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}
          show_full_output: true
          prompt: |
            You are an autonomous AI security agent running inside a GitHub Actions workflow.

            ## Context
            - You are working on the repository ${{ steps.target.outputs.target_repo }}
            - Security vulnerabilities have been detected and exported to `vulnerability_report.json`
            - Your task is to fix these vulnerabilities while maintaining code functionality

            ## Vulnerability Report Structure
            The `vulnerability_report.json` contains:
            ```json
            {
              "vulnerabilities": [
                {
                  "id": "CVE-XXXX",
                  "severity": "high|medium|low|critical",
                  "package": "package-name",
                  "current_version": "1.0.0",
                  "fixed_version": "1.0.1",
                  "file": "package.json",
                  "description": "...",
                  "recommendation": "..."
                }
              ]
            }
            ```

            ## Your Goals
            1. Read `vulnerability_report.json` to understand all vulnerabilities
            2. Fix critical and high severity issues first
            3. For dependency vulnerabilities:
               - Update versions in package.json, requirements.txt, etc.
               - Run `npm install` or `pip install -r requirements.txt` to update lockfiles
            4. For code vulnerabilities:
               - Apply the recommended fix
               - Ensure proper input validation, sanitization, etc.
            5. Run tests to verify fixes don't break functionality
            6. Create `SECURITY_FIX_SUMMARY.md` documenting all fixes

            ## Important Constraints
            - You are running non-interactively. Do not ask for user input.
            - DO NOT create git commits - the workflow handles this.
            - DO NOT use subshells like `bash -c '...'`
            - Focus on fixing vulnerabilities, not refactoring unrelated code
            - If a fix would cause breaking changes, document it and skip

            ## Required Output
            When finished, print a JSON summary to stdout:
            ```json
            {
              "fixed_count": number,
              "skipped_count": number,
              "skipped_reasons": ["reason1", "reason2"],
              "severity_fixed": {"critical": 0, "high": 0, "medium": 0, "low": 0},
              "tests_passed": true | false | null
            }
            ```
          
          claude_args: |
            --dangerously-skip-permissions
            --settings .claude-config/settings.json
            --allowedTools "Bash" "Edit" "Read" "Write" "LS" "Glob" "Grep"
            --max-turns 50

      - name: Save Claude Agent Summary
        if: always() && steps.merge_reports.outputs.vuln_count != '0'
        run: |
          cat > claude_security_summary.json <<'EOF'
          ${{ steps.claude_agent.outputs.agent_output || '{"error": "No output captured"}' }}
          EOF
          echo "Claude agent finished. Summary saved."

      - name: Upload Claude Summary
        if: always() && steps.merge_reports.outputs.vuln_count != '0'
        uses: actions/upload-artifact@v4
        with:
          name: claude-security-fix-summary
          path: |
            claude_security_summary.json
            SECURITY_FIX_SUMMARY.md
          retention-days: 30

      - name: Commit and Create PR
        if: steps.merge_reports.outputs.vuln_count != '0'
        env:
          OWNER: ${{ steps.target.outputs.owner }}
          REPO: ${{ steps.target.outputs.repo }}
          BASE_BRANCH: ${{ steps.target.outputs.branch }}
          BRANCH_NAME: ${{ env.branch_name }}
          GH_TOKEN: ${{ github.token }}
        run: |
          echo "Checking for security fixes to commit..."
          
          # Remove generated files
          rm -f vulnerability_report.json *_vulnerabilities.json *_raw.json
          rm -rf .claude-config CLAUDE.md
          
          if [ -z "$(git status --porcelain)" ]; then
            echo "No changes detected from Claude agent; skipping commit and PR creation."
            exit 0
          fi
          
          git add -A
          git commit -m "Security fixes applied by Claude Code Agent

          Vulnerabilities fixed based on security scan results.
          See SECURITY_FIX_SUMMARY.md for details."
          
          echo "Pushing branch $BRANCH_NAME..."
          # Push using token in URL to avoid credential issues
          git push https://x-access-token:${GH_TOKEN}@github.com/${OWNER}/${REPO}.git HEAD:refs/heads/$BRANCH_NAME --force
          
          echo "Creating PR for security fixes..."
          
          gh pr create \
            --repo "$OWNER/$REPO" \
            --base "$BASE_BRANCH" \
            --head "$BRANCH_NAME" \
            --title "ðŸ”’ Security fixes by Claude Code Agent" \
            --body "## Automated Security Fixes

          This PR was generated automatically by the Claude Code Agent to address security vulnerabilities.

          ### Scan Results
          - **Scan Tool**: ${{ steps.target.outputs.scan_tool }}
          - **Minimum Severity**: ${{ steps.target.outputs.fix_severity }}
          - **Vulnerabilities Found**: ${{ steps.merge_reports.outputs.vuln_count }}

          ### Changes Applied
          See \`SECURITY_FIX_SUMMARY.md\` for a detailed list of fixes.

          ### Review Required
          Please review these security fixes carefully before merging.
          
          âš ï¸ Some fixes may require manual verification or additional testing." || echo "PR may already exist"
          
          echo "Successfully created security fix PR."
